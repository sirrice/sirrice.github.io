<html>
   <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>SQL2pandas</title>
  </head>
<body>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h2 id="msg">Loading Pyodide.  Text boxes disabled until ready.</h2>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <h3>1. Python (run first to add data to db)</h3>
      <textarea disabled id="py">
csv = """a,b,c,d,e,f,g
0,0,0,0,a,2,c
1,1,1,0,b,4,d
2,2,0,0,c,6,e
3,3,1,0,d,8,cde
4,4,0,0,abc,10,a
5,0,1,0,cde,12,b
6,1,0,0,a,14,c
7,2,1,0,b,16,abc
8,3,0,0,c,18,c
9,4,1,0,d,20,d
10,0,0,0,abc,22,e
11,1,1,0,cde,24,cde
12,2,0,0,a,26,a
13,3,1,0,b,28,b
14,4,0,0,c,30,c
15,0,1,0,d,32,abc
16,1,0,0,abc,34,c
17,2,1,0,cde,36,d
18,3,0,0,a,38,e
19,4,1,0,b,40,cde"""
data = pd.read_csv(io.StringIO(csv))
db.register_dataframe("data", data)

      </textarea>
      <button id="pythonbtn">Run</button>
      <div class="alert alert-info" id="pyout"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <h3>2. SQL (then translate sql)</h3>
      <textarea disabled id="q">
SELECT a, sum(b+2) * 2 as c 
FROM data, (SELECT 1 as x FROM data) AS d2 
WHERE data.a = d2.x
GROUP BY a
      </textarea>
      <button id="sqlbtn">Translate</button>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <h3>Generated Pandas Code</h3>
      <p><mark>db</mark> is a dictionary from tablename to data frame.  You can replace references with direct assignments to dataframes.</p>
      <textarea class="alert alert-info code" id="pandas">

      </textarea>
    </div>
  </div>

</div>


</body>

<link rel="stylesheet" type="text/css" href="./files/css/bootstrap.min.css" />
<script src="./files/js/jquery.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
<script>
async function main() {

  let pyodide = await loadPyodide();

  $("#msg").text("Loading numpy..")
  await pyodide.loadPackage(["micropip", "numpy"])

  $("#msg").text("Loading pandas..")
  await pyodide.loadPackage(["pandas", "python-dateutil"])
  $("#msg").text("Loading sql2pandas wheel..")

  await pyodide.runPythonAsync(`
 import pandas as pd
 import io
 import micropip
 await micropip.install("./files/python/parsimonious-0.9.0-py3-none-any.whl")
 await micropip.install('./files/python/sql2pandas-0.0.3-py3-none-any.whl')
 import sql2pandas
 db = sql2pandas.Database.db()
  `)
  $("#msg").text("Ready!")

  $("textarea").prop("disabled", false);

    $("#pythonbtn").click(() => {
        let code = $("#py").val();
        console.log(code);
        pyodide.runPython(code)
        let ret = pyodide.runPython(`"Registered Tables: " + ", ".join(db.tablenames)`)
        $("#pyout").html(ret)
    })

    $("#sqlbtn").click(() => {
        let q = $("#q").val().replace(/\s/g, ' ')
        console.log(q)
        let pandascode = pyodide.runPython(` sql2pandas.sql2pandas("""${q}""").ctx.compiler.compile() `);
        $("#pandas").html(pandascode)
    })
};



main();
</script>

<style>
body, textarea, code {
  font-size: 12pt;
}
textarea, code {
  padding: 1em;
  width: 80%;
  height: 10em;
  font-family: monospace;
}
.alert, button {
  display: block;
  width: 80%;
}
.code {
  height: 20em;
}
*:disabled {
  color: gray;
}
</style>



</html>